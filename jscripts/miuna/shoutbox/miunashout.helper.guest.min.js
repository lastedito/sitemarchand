function escapeHtml(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})}function regexment(t,e){var a=t.match(/(?:^|\s)@&quot;([^<]+?)&quot;|(?:^|\s)@&#039;([^<]+?)&#039;|(?:^|\s)@`([^<]+?)`|(?:^|\s)@(?:([^"<>\.,;!?()\[\]{}&\'\s\\]{3,}))/gim);if(a){for(var n=new RegExp(e,"gi"),o=0;o<a.length;o++)if(res=n.exec(a[o]),e.toUpperCase()==String(res).toUpperCase())return 1;return 0}return 0}function regexmiuna(t){format_search=[/\[url=(.*?)\](.*?)\[\/url\]/gi,/\[spoiler\](.*?)\[\/spoiler\]/gi,/(^|[^"=\]])(https?:\/\/[a-zA-Z0-9\.\-\_\-\/]+(?:\?[a-zA-Z0-9=\+\_\;\-\&]+)?(?:#[\w]+)?)/gim,/(^|[^"=\]\>\/])(www\.[\S]+(\b|$))/gim,/(^|[^"=\]])(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim],format_replace=['<a href="$1" target="_blank">$2</a>','<tag><div style="margin: 5px"><div style="font-size:11px; border-radius: 3px 3px 0 0 ; padding: 4px; background: #f5f5f5;border:1px solid #ccc;font-weight:bold;color:#000;text-shadow:none; ">'+spo_lan+":&nbsp;&nbsp;<input type=\"button\" onclick=\"if (this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display != '') { this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display = '';this.innerText = ''; this.value = '"+hide_lan+"'; } else { this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display = 'none'; this.innerText = ''; this.value = '"+show_lan+'\'; }" style="font-size: 9px;" value="'+show_lan+'"></div><div><div style="border:1px solid #ccc; border-radius: 0 0 3px 3px; border-top: none; padding: 4px;display: none;">$1</div></div></div></tag>','$1<a href="$2" target="_blank">$2</a>','$1<a href="http://$2" target="_blank">$2</a>','<a href="mailto:$1">$1</a>'];for(var e=0;e<format_search.length;e++)t=t.replace(format_search[e],format_replace[e]);for(var a in miuna_smilies)t=t.replace(new RegExp(""+a+"(?!\\S)","gi"),miuna_smilies[a]);return t}function imgconv(t){$("div."+t+", [data-idpos="+t+"]").find("a[href*='.jpg'], a[href*='.gif'], a[href*='.png']").each(function(){var t=$(this).attr("href");$(this).children("img").length||$(this).empty().append('<img src="'+t+'" style="max-width:80px; max-height:80px" />')})}function scrollmiuna(t,e,a,n){("top"!=e&&$(""+a).scrollTop()+$(""+a)[0].offsetHeight>$(""+a)[0].scrollHeight-90||"old"==n)&&$("div."+t+" img, [data-idpos="+t+"] img").one("load",function(){$(""+a).animate({scrollTop:$(""+a)[0].scrollHeight},10)}).each(function(){this.complete&&$(this).load()})}function autocleaner(t,e,a,n){$(""+t).children("div."+e).length>parseInt(a)-1&&(dif=$(""+t).children("div."+e).length-(parseInt(a)-1),"top"==n?$(""+t).children("div."+e).slice(-dif).remove():$(""+t).children("div."+e).slice(0,dif).remove()),setTimeout(function(){document.title=$(".shoutarea").children("[data-ment=yes]").length?"("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit:orgtit},200)}function shoutgenerator(t,e,a,n,o,s,r,i,l,c,d,u,m){var p=lanpm=pmspan=area=scrollarea=count="";"top"==u?(p="prepend","logback"==t&&(p="append")):(p="append","logback"==t&&(p="prepend")),a==n?(lanpm=pm_fromlan,r=s):(lanpm=pm_tolan,r=r),"shout"==t?(area=scrollarea=".shoutarea",count="msgstcount",autocleaner(area,count,m,u)):"pm"==t?(area=scrollarea="[data-uidpm="+a+"]",count="pmmsgstcount",autocleaner(area,count,m,u)):(area=".loglist",scrollarea=".logstyle",count="msglog"),"shout"!=t&&"lognext"!=t&&"logback"!=t||"pmshout"!=c&&"pmsystem"!=c||(pmspan="<span class='pm_inf'>["+lanpm+" "+r+"] </span>"),("shout"==c||"pmshout"==c)&&($(""+area)[p]("<div class='msgShout "+count+" "+e+"' data-uid="+n+" data-ided="+e+"><span class='time_msgShout'><span>[</span>"+o+"<span>]</span></span>"+pmspan+"<span class='username_msgShout'>"+s+"</span>:<span class='content_msgShout' style='"+i+"'>"+l+"</span></div>"),("top"!=u&&$(""+scrollarea).scrollTop()+$(""+scrollarea)[0].offsetHeight>$(""+scrollarea)[0].scrollHeight-90||"old"==d)&&$(""+scrollarea).animate({scrollTop:$(""+scrollarea)[0].scrollHeight},10)),("system"==c||"pmsystem"==c)&&($(""+area)[p]("<div class='msgShout "+count+" "+e+"' data-uid="+n+" data-ided="+e+">"+pmspan+"*<span class='username_msgShout'>"+s+"</span><span class='content_msgShout' style='"+i+"'>"+l+"</span>*</div>"),("top"!=u&&$(""+scrollarea).scrollTop()+$(""+scrollarea)[0].offsetHeight>$(""+scrollarea)[0].scrollHeight-90||"old"==d)&&$(""+scrollarea).animate({scrollTop:$(""+scrollarea)[0].scrollHeight},10)),imgconv(e),scrollmiuna(e,u,scrollarea,d)}function miunashout(t,e,a){function n(t){$(".actusr").text(""+usractlan+" "+Object.keys(t.usernames).length)}function o(t,a,n,o,s,r,i,c,d,u,m,p){var g=moment(m).utcOffset(parseInt(zoneset)).format(zoneformt);a=regexmiuna(a),nums=numshouts,"log"==t&&(nums=mpp),shoutgenerator(t,u,o,s,g,n,r,c,a,d,p,direction,nums),1==l[s]&&$("[data-uid="+s+"]").find(".time_msgShout span").css("color",on_color),regexment(a,e)&&($("div."+u).css("border-left",ment_borderstyle).attr("data-ment","yes"),setTimeout(function(){$(".shoutarea").children("[data-ment=yes]").length&&(document.title="("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit)},200)),"1"==i&&$("div."+u).css("background-color",edt_color)}function s(e,a,n,s,r,i,l,c,d,u,m,p){var g="shout";if(("lognext"==e||"logback"==e)&&(g=e),0==s)o(g,a,n,r,r,s,l,c,d,u,m,p);else if(r==t){if(("msg"==e||"lognext"==e||"logback"==e)&&o(g,a,n,i,r,s,l,c,d,u,m,p),!$("[data-uidpm="+i+"]").length||"lognext"==e||"logback"==e)return;o("pm",a,n,i,r,s,l,c,d,u,m,p)}else{if(i!=t)return;if(("msg"==e||"lognext"==e||"logback"==e)&&o(g,a,n,r,r,s,l,c,d,u,m,p),!$("[data-uidpm="+r+"]").length||"lognext"==e||"logback"==e)return;o("pm",a,n,r,r,s,l,c,d,u,m,p)}}function r(t,a){t=regexmiuna(t),setTimeout(function(){imgconv(a),$(".shoutarea").children().hasClass(a)&&scrollmiuna(a,direction,".shoutarea","new"),"undefined"!=typeof $("div."+a).parent(".pmarea").attr("data-uidpm")&&(area2="[data-uidpm="+$("div."+a).parent(".pmarea").attr("data-uidpm")+"]",scrollmiuna(a,direction,area2,"new"))},50);var n=regexment(t,e);"yes"==$("div."+a).attr("data-ment")&&(n||($("div."+a).css("border-left","").attr("data-ment","no"),setTimeout(function(){document.title=$(".shoutarea").children("[data-ment=yes]").length?"("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit:orgtit},200))),n&&($("div."+a).css("border-left",ment_borderstyle).attr("data-ment","yes"),setTimeout(function(){document.title="("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit},200)),$("div."+a).children(".content_msgShout").html(t),$("div."+a).css("background-color",edt_color)}var i=(floodtime,""),l="",c=!1;socket.once("login",function(e){c=!0,n(e),i=e.usernames,l=e.uidlist,socket.emit("getoldmsg",{ns:numshouts,uid:t})}),socket.on("user joined",function(t){n(t),i=t.usernames,l=t.uidlist,$("[data-uid="+t.uid+"]").length&&$("[data-uid="+t.uid+"]").find(".time_msgShout span").css("color",on_color)}),socket.on("user left",function(t){n(t),i=t.usernames,l=t.uidlist,$("[data-uid="+t.uid+"]").length&&$("[data-uid="+t.uid+"]").find(".time_msgShout span").css("color","")}),socket.emit("add user",{nick:a,uidts:parseInt(t)}),socket.emit("getnot",function(){}),socket.once("getnot",function(t){t&&$(".notshow").text(t.not)}),socket.on("updnot",function(t){$(".notshow").text(t?t.not:"")}),socket.once("load old msgs",function(t){for(var e=t.length-1;e>=0;e--)s("msg",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].uidto,t[e].edt,t[e].stylesheet,t[e].type,t[e]._id,t[e].created,"old")}),socket.on("message",function(t){s("msg",t.msg,t.nick,t.nickto,t.uid,t.uidto,t.edt,t.stylesheet,t.type,t._id,t.created,"new")}),socket.on("updmsg",function(t){t&&r(t.newmsg,t.id)}),socket.on("rmvmsg",function(t){t&&$("div.wrapShout").children("div."+t.id).remove()}),($.fn.on||$.fn.live).call($(document),"click",".shouttab",function(t){t.preventDefault(),$(".tabShout").removeClass("selected"),$(".shouttab").addClass("selected"),$(".wrapShout").hide(),$(".shoutarea").show(),"top"!=direction&&$(".shoutarea").animate({scrollTop:$(".shoutarea")[0].scrollHeight},10),$("#shout_text").attr("data-type","shout")}),($.fn.on||$.fn.live).call($(document),"click",".actusr",function(t){function e(t){$("#onnow").prepend('<span class="usron">'+t+", </span>")}t.preventDefault(),$(".tabShout").removeClass("selected"),$(".actusr").addClass("selected"),$(".numusr").html('<div id="onnow"></div>'),Object.keys(i).map(function(t){e(i[t])});var a=$(".usron:last").html();a&&$(".usron:last").html(a.slice(0,-2)),$(".wrapShout").hide(),$(".numusr").show()})}